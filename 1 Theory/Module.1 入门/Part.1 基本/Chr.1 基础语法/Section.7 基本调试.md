# 基本调试

[TOC]

---

调试（Debugging）是发现并解决程序错误的过程，是开发者的核心技能之一。无论编写多简单的代码，都难免会遇到错误或不符合预期的行为。掌握基本的调试方法，能帮助你快速定位问题根源，提高开发效率。

本章将介绍 JavaScript 在浏览器和 Node.js 环境中的常用调试工具与技巧，涵盖从简单的 `console.log` 到断点调试的各种方法，以及常见错误类型的排查思路。

---

## 1. 调试概述

程序的错误通常分为三类：

- **语法错误**：代码不符合语言规则，导致解析失败。这类错误最容易发现，通常在编写代码时就会被编辑器或运行环境提示。
- **运行时错误**：代码在运行过程中抛出异常，如调用未定义的函数、访问不存在的属性等。
- **逻辑错误**：代码能运行，但结果不符合预期。这是最难排查的错误，需要仔细检查算法和逻辑。

调试的目的就是定位并修复这些错误。现代开发工具提供了丰富的调试功能，让开发者可以动态观察程序运行状态，而不只是靠肉眼看代码。

---

## 2. 浏览器中的调试

浏览器开发者工具是前端开发最强大的调试环境。以 Chrome 为例，按 `F12` 或 `Ctrl+Shift+I`（Windows/Linux）/ `Cmd+Option+I`（Mac）打开开发者工具。

### 2.1 开发者工具简介

开发者工具包含多个面板，调试常用的是：

- **Elements**：查看和修改 DOM、CSS。
- **Console**：执行 JavaScript 代码、查看日志、错误信息。
- **Sources**：源代码管理、断点调试、调用栈查看。
- **Network**：监控网络请求。
- **Performance**：性能分析。

### 2.2 使用 `console` 输出调试信息

最简单且常用的调试方式是在代码中插入 `console.log()`，输出变量值或执行流程标记。

```javascript
function calculateTotal(price, quantity) {
  console.log('price:', price, 'quantity:', quantity); // 检查输入
  let total = price * quantity;
  console.log('total:', total); // 检查中间结果
  if (total > 100) {
    console.log('应用折扣');
    total *= 0.9;
  }
  return total;
}
```

除了 `log`，还有：

- `console.warn()`、`console.error()`：以不同样式输出，便于区分。
- `console.table()`：以表格形式输出数组或对象。
- `console.time()` / `console.timeEnd()`：测量代码执行时间。
- `console.trace()`：打印当前调用栈。

**注意**：发布生产环境前应移除或注释掉调试输出，避免影响性能和泄露信息。

### 2.3 断点调试

断点调试可以让代码在执行到指定行时暂停，此时可以查看变量、调用栈、甚至修改变量值。

**设置断点的方法**：

1. 在 Sources 面板中找到要调试的脚本文件，点击行号左侧即可添加断点。
2. 在代码中通过 `debugger;` 语句添加断点，当开发者工具打开时，执行到该行会自动暂停。

```javascript
function processData(data) {
  debugger; // 程序将在此处暂停
  let result = data.map(item => item.value);
  return result;
}
```

**断点类型**：

- **普通断点**：执行到该行暂停。
- **条件断点**：右键点击行号，可设置一个条件表达式，只有当表达式为真时才暂停。适合在循环中调试特定情况。
- **DOM 断点**：在 Elements 面板中右键点击元素，可以监听属性修改、节点移除等事件。
- **XHR 断点**：在 Sources 面板右侧的 XHR Breakpoints 中可以添加断点，拦截特定的 AJAX 请求。

### 2.4 单步执行与状态查看

代码暂停后，可以通过控制按钮逐行执行：

- **继续（F8）**：恢复执行直到下一个断点。
- **步过（F10）**：执行当前行，如果遇到函数调用，不进入函数内部。
- **步入（F11）**：进入当前行调用的函数内部。
- **步出（Shift+F11）**：从当前函数中跳出，返回到调用处。

**查看变量**：

- 将鼠标悬停在代码中的变量上，可查看当前值。
- 右侧 **Scope** 面板显示当前作用域内的所有变量（局部、闭包、全局）。
- **Watch** 面板可添加自定义表达式，实时跟踪其值。

**调用栈**：右侧 **Call Stack** 面板显示当前断点处的函数调用链，有助于理解执行流程。

### 2.5 异常断点

开发者工具可以设置在抛出异常时自动暂停，即使异常被 `try...catch` 捕获，也可以选择暂停。

- 在 Sources 面板右侧，点击 **Pause on exceptions** 按钮（暂停符号），可选择暂停所有异常或仅未捕获的异常。

### 2.6 实时修改代码

在 Sources 面板中，可以直接编辑代码（例如修改某行逻辑），保存后（Ctrl+S）会立即生效，无需刷新页面。这对于快速验证想法非常有用。

---

## 3. Node.js 中的调试

Node.js 运行在服务器端，没有浏览器界面，但同样提供了多种调试方式。

### 3.1 使用 `console.log`

与浏览器一样，在 Node.js 中最简单的调试也是通过 `console.log` 输出信息到终端。

```javascript
const express = require('express');
const app = express();

app.get('/', (req, res) => {
  console.log('收到请求'); // 标记请求到达
  res.send('Hello');
});
```

### 3.2 Node.js 内置调试器

Node.js 提供了一个基于命令行的简易调试器，可以通过 `node inspect` 启动脚本：

```bash
node inspect app.js
```

进入调试模式后，可以使用 `cont`、`next`、`step` 等命令控制执行。但这种方式使用较少，通常更推荐使用 IDE 或 Chrome 开发者工具。

### 3.3 使用 Chrome 开发者工具调试 Node.js

Node.js 支持通过 Chrome 开发者工具进行调试，步骤如下：

1. 启动 Node.js 程序时加上 `--inspect` 或 `--inspect-brk` 标志：

   ```bash
   node --inspect-brk app.js
   ```

   `--inspect-brk` 会在程序第一行暂停，等待调试器连接。

2. 在 Chrome 浏览器中打开 `chrome://inspect`，点击 `Open dedicated DevTools for Node`，即可连接到 Node.js 进程，使用熟悉的断点调试界面。

### 3.4 VS Code 调试

Visual Studio Code 内置了强大的 Node.js 调试支持。

**配置方法**：

1. 打开项目，点击左侧调试图标（或按 `Ctrl+Shift+D`）。
2. 点击“创建 launch.json 文件”，选择 Node.js 环境。
3. 生成的配置文件中，可以设置启动程序、参数、环境变量等。

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "type": "node",
      "request": "launch",
      "name": "启动程序",
      "skipFiles": ["<node_internals>/**"],
      "program": "${workspaceFolder}/app.js"
    }
  ]
}
```

之后就可以在代码行号左侧点击添加断点，按 `F5` 启动调试，体验与浏览器类似的调试功能（变量查看、调用栈、监视等）。

### 3.5 使用 `ndb` 工具

`ndb` 是由 Chrome 团队开发的 Node.js 调试工具，提供了更友好的调试体验。全局安装后，直接运行 `ndb app.js` 即可打开调试界面。

---

## 4. 常见错误类型与排查思路

### 4.1 语法错误

**现象**：代码无法运行，控制台报错，如 `Uncaught SyntaxError: Unexpected token`。

**常见原因**：缺少括号、引号不匹配、使用关键字作为变量名等。

**排查方法**：编辑器通常会高亮错误位置，仔细检查附近代码即可。

### 4.2 运行时错误

**现象**：程序运行过程中抛出异常，如 `ReferenceError: x is not defined`、`TypeError: Cannot read property 'xxx' of undefined`。

**常见原因**：变量未定义、调用不存在的方法、访问 `null` 或 `undefined` 的属性。

**排查方法**：

- 查看错误堆栈，定位到抛出异常的行号。
- 检查该行涉及的变量是否已正确初始化。
- 使用断点调试，在异常发生前观察变量状态。

### 4.3 逻辑错误

**现象**：程序能运行，但输出结果与预期不符，没有报错。

**排查方法**：

- 确定预期结果与实际结果的差异。
- 在关键位置添加 `console.log` 输出中间值，逐步缩小范围。
- 使用断点逐步跟踪，观察变量变化是否符合逻辑。
- 检查边界条件（空数组、负值、最大值等）。
- 考虑使用单元测试验证函数行为。

---

## 5. 调试技巧与最佳实践

### 5.1 二分法定位错误

当代码较长时，可以在疑似有问题的区域中间位置设置断点或添加输出。如果前半部分正常，则错误在后半部分；反之亦然。如此反复，快速缩小范围。

### 5.2 复现条件

有些错误只在特定条件下出现（如特定用户、特定数据）。尝试找到稳定的复现步骤，有助于精准调试。

### 5.3 使用 Source Map

在生产环境中，代码可能经过压缩、打包，难以阅读。Source Map 可以将压缩后的代码映射回原始源代码，让你在生产环境也能定位到原始文件的行号。构建工具（如 Webpack）通常支持生成 Source Map。

### 5.4 日志分级与持久化

在复杂应用中，可以考虑引入日志库（如 `winston`、`log4js`），将不同级别的日志输出到文件或日志服务，便于事后分析。

### 5.5 避免过度调试

不是所有问题都需要断点调试。简单的错误通过 `console.log` 即可快速定位。学会根据问题复杂程度选择合适的调试手段。

### 5.6 保持代码可测试

将逻辑拆分成小的、可独立测试的函数，有助于快速定位错误，也便于编写单元测试。

---

## 6. 小结

调试是编程过程中的必备技能。本章介绍了：

- **浏览器调试**：利用开发者工具进行断点、单步执行、变量监视等。
- **Node.js 调试**：通过 `console.log`、内置调试器、VS Code 或 Chrome 工具进行调试。
- **错误类型**：语法错误、运行时错误、逻辑错误，以及各自的排查思路。
- **调试技巧**：二分法、复现条件、Source Map、日志等。

掌握这些工具和方法，你就能更高效地发现并解决问题，写出更健壮的代码。下一节我们将进入结构化编程，学习函数、数据结构等更高级的概念。

# window 对象

[TOC]

---

`window` 对象是浏览器环境中的**全局对象**，它代表浏览器窗口或标签页。在浏览器中，所有通过 `var` 声明的全局变量、全局函数以及浏览器提供的许多 API 都挂载在 `window` 对象上。理解 `window` 对象是掌握 BOM（浏览器对象模型）的基础，它提供了操作浏览器窗口、访问文档、管理定时器、处理用户界面等一系列核心功能。

---

## 1. 概述

### 1.1 什么是 window 对象？

`window` 对象是 BOM 的顶层对象，每个打开的浏览器窗口或标签页都有一个对应的 `window` 对象。它既是一个 JavaScript 全局对象，也是浏览器窗口的抽象表示。

- **作为全局对象**：所有在全局作用域中声明的变量和函数都会成为 `window` 对象的属性和方法。
- **作为窗口接口**：提供控制浏览器窗口的属性和方法（如大小、位置、滚动等）。

### 1.2 全局作用域

在浏览器中，以下情况会挂载到 `window` 对象：

```javascript
var globalVar = 'Hello';          // 成为 window.globalVar
function globalFunc() {}          // 成为 window.globalFunc
let notGlobal = 'Let';            // let/const 声明的变量不会成为 window 属性
```

**注意**：使用 `let` 和 `const` 在全局作用域声明的变量不会添加到 `window` 对象，但它们仍然是全局作用域的一部分（可通过直接访问使用）。

---

## 2. window 的常用属性

`window` 对象包含大量属性，许多本身就是重要的子对象。下面列出最常用的一部分：

| 属性                                                     | 描述                                                                           |
| -------------------------------------------------------- | ------------------------------------------------------------------------------ |
| `document`                                               | 指向当前窗口的 `document` 对象，即 DOM 树的根。                                |
| `location`                                               | 提供当前 URL 信息，并可进行导航操作。                                          |
| `history`                                                | 允许操作浏览器的会话历史（前进、后退等）。                                     |
| `navigator`                                              | 包含浏览器和操作系统信息，如用户代理、平台等。                                 |
| `screen`                                                 | 提供有关用户屏幕的信息（尺寸、色彩深度等）。                                   |
| `frames`                                                 | 返回当前窗口中所有子框架（`<iframe>`）的集合。                                 |
| `localStorage`                                           | 提供持久化的本地存储（无过期时间）。                                           |
| `sessionStorage`                                         | 提供会话级别的本地存储（页面关闭后清除）。                                     |
| `console`                                                | 提供控制台调试方法（`log`、`error`、`warn` 等）。                              |
| `performance`                                            | 提供性能相关信息（如时间度量、导航计时）。                                     |
| `crypto`                                                 | 提供基本的加密功能（如随机数生成）。                                           |
| `name`                                                   | 获取或设置窗口名称，通常用于超链接或表单的目标。                               |
| `closed`                                                 | 布尔值，表示窗口是否已被关闭。                                                 |
| `opener`                                                 | 返回打开当前窗口的窗口的引用。                                                 |
| `parent` / `top` / `self`                                | 用于框架层次结构，`parent` 指父窗口，`top` 指顶层窗口，`self` 指当前窗口本身。 |
| `innerWidth` / `innerHeight`                             | 返回窗口文档显示区域的宽度和高度（包括滚动条但不含浏览器工具栏）。             |
| `outerWidth` / `outerHeight`                             | 返回浏览器窗口的整体宽度和高度（包括工具栏、边框等）。                         |
| `screenX` / `screenY` (或 `screenLeft` / `screenTop`)    | 窗口相对于屏幕左上角的坐标。                                                   |
| `pageXOffset` / `pageYOffset` (或 `scrollX` / `scrollY`) | 文档水平/垂直滚动的像素数。                                                    |

---

## 3. window 的常用方法

### 3.1 对话框

- **`alert(message)`**：显示一个带有消息和“确定”按钮的模态对话框。
- **`confirm(message)`**：显示一个带有“确定”和“取消”按钮的对话框，返回布尔值（确定返回 `true`，取消返回 `false`）。
- **`prompt(message, default?)`**：显示一个可输入的对话框，返回用户输入的字符串（若取消则返回 `null`）。

```javascript
const name = prompt('请输入你的名字', '访客');
if (name) {
  alert(`你好，${name}！`);
} else {
  alert('你没有输入名字');
}
```

### 3.2 定时器与动画帧

- **`setTimeout(callback, delay, ...args)`**：延迟 `delay` 毫秒后执行 `callback`，返回一个整数 ID（可用于取消）。
- **`clearTimeout(id)`**：取消由 `setTimeout` 设置的定时任务。
- **`setInterval(callback, interval, ...args)`**：每隔 `interval` 毫秒重复执行 `callback`，返回一个整数 ID。
- **`clearInterval(id)`**：取消由 `setInterval` 设置的定时任务。
- **`requestAnimationFrame(callback)`**：在下一次浏览器重绘前执行 `callback`，通常用于动画，返回一个整数 ID。
- **`cancelAnimationFrame(id)`**：取消动画帧请求。

```javascript
// 延时执行
const timerId = setTimeout(() => {
  console.log('执行一次');
}, 1000);

// 取消
clearTimeout(timerId);

// 动画循环
let start;
function step(timestamp) {
  if (start === undefined) start = timestamp;
  const progress = timestamp - start;
  element.style.transform = `translateX(${Math.min(progress / 5, 200)}px)`;
  if (progress < 5000) {
    requestAnimationFrame(step);
  }
}
requestAnimationFrame(step);
```

### 3.3 窗口控制

- **`open(url, name, features, replace?)`**：打开一个新窗口或标签页，并返回新窗口的 `window` 引用。`features` 是窗口特性字符串（如 `width=400,height=300`）。
- **`close()`**：关闭当前窗口。只有通过 `window.open()` 打开的窗口才允许用脚本关闭（用户打开的窗口一般不允许脚本关闭）。
- **`stop()`**：停止加载页面。
- **`focus()`** / **`blur()`**：使窗口获得/失去焦点。
- **`moveTo(x, y)`** / **`moveBy(dx, dy)`**：移动窗口（受安全限制，通常只对弹窗有效）。
- **`resizeTo(width, height)`** / **`resizeBy(dw, dh)`**：调整窗口大小。

```javascript
const popup = window.open('https://example.com', 'popup', 'width=400,height=400');
popup.moveTo(100, 100);
popup.focus();
```

### 3.4 滚动控制

- **`scrollTo(x, y)`**：滚动到文档中的指定坐标。
- **`scrollBy(dx, dy)`**：相对当前滚动位置滚动指定距离。
- **`scrollTo(options)`**：使用选项对象，可设置 `top`、`left` 和 `behavior`（`'smooth'` 实现平滑滚动）。

```javascript
window.scrollTo({ top: 500, behavior: 'smooth' });
```

### 3.5 跨窗口通信

- **`postMessage(message, targetOrigin, transfer?)`**：向其他窗口发送跨源消息，常用于 `iframe` 或弹窗之间的通信。
- **`window.addEventListener('message', handler)`**：监听来自其他窗口的消息。

```javascript
// 在父窗口发送消息给 iframe
const iframe = document.getElementById('child');
iframe.contentWindow.postMessage('hello', 'https://child.example.com');

// 在子窗口接收消息
window.addEventListener('message', (event) => {
  if (event.origin !== 'https://parent.example.com') return;
  console.log('收到消息:', event.data);
  event.source.postMessage('pong', event.origin);
});
```

### 3.6 其他常用方法

- **`addEventListener(type, listener, options)`**：为 `window` 绑定事件（如 `load`、`resize`、`scroll`）。
- **`removeEventListener(type, listener, options)`**：移除事件监听。
- **`dispatchEvent(event)`**：派发自定义事件。
- **`getComputedStyle(element, pseudoElt)`**：返回元素的计算样式（在 `window` 对象上）。
- **`matchMedia(mediaQueryString)`**：返回一个 `MediaQueryList` 对象，用于媒体查询监听。

---

## 4. window 的事件

`window` 对象可以监听多种事件，常见的有：

| 事件                 | 描述                                                                                        |
| -------------------- | ------------------------------------------------------------------------------------------- |
| `load`               | 页面所有资源（包括图片、样式等）加载完成后触发。                                            |
| `DOMContentLoaded`   | 在 `document` 上触发，但可通过 `window` 监听，当 DOM 树构建完成时触发（不等待图片等资源）。 |
| `resize`             | 窗口大小改变时触发。                                                                        |
| `scroll`             | 窗口滚动时触发。                                                                            |
| `unload`             | 页面即将卸载时触发。                                                                        |
| `beforeunload`       | 页面即将卸载前触发，可用于提示用户保存未保存数据。                                          |
| `hashchange`         | URL 中的 hash（片段标识符）改变时触发。                                                     |
| `popstate`           | 浏览器历史条目变化时触发（通常由 `history.pushState` 引起）。                               |
| `online` / `offline` | 网络连接状态改变时触发。                                                                    |
| `focus` / `blur`     | 窗口获得/失去焦点时触发。                                                                   |

**示例**：

```javascript
window.addEventListener('load', () => {
  console.log('页面完全加载');
});

window.addEventListener('resize', () => {
  console.log('窗口大小改变', window.innerWidth, window.innerHeight);
});

window.addEventListener('beforeunload', (e) => {
  e.preventDefault(); // 现代浏览器需要调用 preventDefault 并设置 returnValue
  e.returnValue = '您有未保存的更改，确定离开吗？';
});
```

---

## 5. 窗口关系与框架

在多框架（如 `<frameset>` 或 `<iframe>`）环境中，窗口之间存在层次关系：

- **`window.self`**：指向窗口自身，与 `window` 等价。
- **`window.parent`**：指向包含当前窗口的父窗口（如果当前窗口是子框架）。
- **`window.top`**：指向最顶层的窗口（对于不在框架中的窗口，`top` 指向自身）。
- **`window.frames`**：一个类似数组的对象，包含当前窗口中所有 `<iframe>` 的窗口对象。

```javascript
// 在 iframe 内部访问父窗口的 document
parent.document.getElementById('parent-element');

// 遍历当前窗口的所有子框架
for (let i = 0; i < window.frames.length; i++) {
  console.log(window.frames[i].location.href);
}
```

---

## 6. 其他重要特性

### 6.1 控制台与调试

`window.console` 提供了多个方法用于调试：

- `console.log()`、`console.info()`、`console.warn()`、`console.error()`
- `console.table()`：以表格形式打印数组或对象。
- `console.time()` / `console.timeEnd()`：测量执行时间。
- `console.trace()`：打印调用堆栈。

### 6.2 错误处理

- **`window.onerror`**：全局错误处理函数，可以捕获未被 `try/catch` 处理的运行时错误。
- **`window.onunhandledrejection`**：处理未捕获的 Promise 拒绝。

```javascript
window.onerror = function(message, source, lineno, colno, error) {
  console.error('全局错误:', message, 'at', source, lineno, colno);
  return true; // 防止浏览器默认打印错误到控制台
};

window.onunhandledrejection = (event) => {
  console.warn('未处理的 Promise 拒绝:', event.reason);
  event.preventDefault(); // 可选，阻止默认行为
};
```

### 6.3 性能与计时

- **`window.performance`**：提供高精度时间戳和性能相关数据，可用于测量页面加载时间、自定义性能指标等。

```javascript
const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
console.log('页面加载时间:', loadTime, 'ms');
```

---

## 7. 最佳实践与注意事项

1. **避免直接修改 `window` 对象**：向 `window` 添加过多的自定义属性可能导致命名冲突，尤其在使用第三方库时。尽量使用模块化作用域。

2. **合理使用定时器**：`setInterval` 可能导致连续调用，如果执行时间过长，可能重叠。考虑使用 `setTimeout` 递归模拟间隔，或使用 `requestAnimationFrame` 处理动画。

3. **处理 `beforeunload` 事件需谨慎**：滥用可能导致用户无法离开页面，通常只应在有未保存修改时提示。

4. **跨窗口通信安全**：使用 `postMessage` 时务必验证 `event.origin` 和 `event.source`，防止恶意消息注入。

5. **注意浏览器兼容性**：某些属性或方法在不同浏览器中可能有差异（如 `innerWidth` 是否包含滚动条），开发时需测试主流浏览器。

6. **垃圾回收与内存泄漏**：当不再需要定时器或事件监听时，务必清除（`clearTimeout`、`removeEventListener`），避免内存泄漏。

7. **使用 `window.matchMedia` 代替手动检测**：响应式设计可通过 `matchMedia` 监听媒体查询变化，更高效。

---

## 小结

`window` 对象是浏览器端 JavaScript 的全局舞台，它集成了窗口控制、文档访问、用户交互、异步任务管理等一系列核心功能。掌握 `window` 的属性和方法，是构建丰富、动态 Web 应用的必备基础。通过本章的学习，你应该能够：

- 理解 `window` 作为全局对象和窗口接口的双重角色。
- 熟练使用常用属性（`document`、`location`、`navigator`、`localStorage` 等）。
- 调用对话框、定时器、窗口控制和滚动方法。
- 处理窗口事件和跨窗口通信。
- 遵循安全与性能最佳实践。

在后续的 BOM 章节中，我们将深入讲解 `location`、`history`、`navigator` 等子对象，进一步完善你对浏览器对象模型的理解。

# navigator 与用户代理

[TOC]

---

`navigator` 对象是浏览器对象模型（BOM）中提供浏览器本身信息的核心对象。它包含了浏览器的版本、运行平台、语言设置、是否在线、支持的硬件特性等一系列属性，以及一些用于与设备交互的方法。通过 `navigator`，开发者可以了解用户的浏览环境，从而做出相应的优化或功能适配。同时，用户代理字符串（User-Agent）作为 `navigator` 的重要组成部分，长期以来被用于识别浏览器类型和版本，但如今已逐渐被特征检测所取代。

---

## 1. 概述

`navigator` 对象存在于 `window` 对象下，可以直接通过 `window.navigator` 或 `navigator` 访问。它提供了关于运行脚本的浏览器和操作系统信息。这些信息对于：

- **统计分析**：了解用户使用的浏览器版本分布。
- **功能降级/增强**：针对不同浏览器提供不同的体验。
- **调试**：快速查看当前环境。
- **与设备交互**：如获取地理位置、振动、剪贴板等（部分通过 `navigator` 的子对象实现）。

**注意**：`navigator` 的属性值可能被用户修改或浏览器伪造，因此不能完全依赖其进行安全决策。

---

## 2. 常用属性

`navigator` 对象包含大量属性，下面列出最常用和重要的部分：

| 属性                  | 描述                                                                  | 示例值                                                                                                              |
| --------------------- | --------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------- |
| `userAgent`           | 浏览器发送给服务器的用户代理字符串。                                  | `"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"` |
| `appName`             | 浏览器名称。大多数现代浏览器返回 `"Netscape"`（出于历史原因）。       | `"Netscape"`                                                                                                        |
| `appVersion`          | 浏览器版本信息，但格式不统一。                                        | `"5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"`         |
| `platform`            | 浏览器所在的操作系统（可能被伪装）。                                  | `"Win32"`、`"MacIntel"`、`"Linux x86_64"`                                                                           |
| `language`            | 首选语言（浏览器 UI 语言），通常是 `navigator.languages[0]`。         | `"zh-CN"`、`"en-US"`                                                                                                |
| `languages`           | 用户接受的语言列表（按优先级排序）的数组。                            | `["zh-CN", "en", "zh"]`                                                                                             |
| `cookieEnabled`       | 布尔值，表示是否启用了 cookie。                                       | `true` / `false`                                                                                                    |
| `onLine`              | 布尔值，表示浏览器是否处于在线状态。                                  | `true` / `false`                                                                                                    |
| `hardwareConcurrency` | 可用的逻辑处理器核心数（用于决定并行任务数量）。                      | `8`                                                                                                                 |
| `deviceMemory`        | 设备内存大小（GB），可能为 `undefined` 或近似值。                     | `8`                                                                                                                 |
| `maxTouchPoints`      | 屏幕支持的最大触摸点数。                                              | `0`（无触摸）、`5`                                                                                                  |
| `vendor`              | 浏览器供应商名称。Chrome 返回 `"Google Inc."`，Firefox 返回空字符串。 | `"Google Inc."`                                                                                                     |
| `product`             | 始终为 `"Gecko"`（兼容性保留）。                                      | `"Gecko"`                                                                                                           |
| `doNotTrack`          | 用户是否启用了“请勿追踪”（已废弃，值可能为 `"1"` 或 `null`）。        | `null`                                                                                                              |
| `buildID`             | 浏览器的构建标识符（通常 Firefox 中有）。                             | `"20230101000000"`                                                                                                  |
| `webdriver`           | 如果浏览器被自动化工具控制（如 Selenium），则为 `true`。              | `false`                                                                                                             |

### 2.1 语言偏好

`navigator.language` 和 `navigator.languages` 用于确定用户偏好的语言，这在国际化（i18n）中非常重要。

```javascript
// 获取用户首选语言（简写）
const primaryLang = navigator.language; // 'zh-CN'

// 获取完整语言列表
const allLangs = navigator.languages;   // ['zh-CN', 'en', 'zh']

// 在请求中设置 Accept-Language 头（浏览器自动处理）
```

### 2.2 在线状态检测

`navigator.onLine` 反映浏览器的网络连接状态，但它的行为因浏览器而异：某些浏览器中，它只表示浏览器能否连接到局域网，不保证互联网可达。更可靠的方式是结合 `online`/`offline` 事件和实际请求检测。

```javascript
if (navigator.onLine) {
  console.log('在线');
} else {
  console.log('离线');
}

window.addEventListener('online', () => console.log('网络连接已恢复'));
window.addEventListener('offline', () => console.log('网络连接已断开'));
```

### 2.3 硬件信息

- `hardwareConcurrency` 可用于动态调整 Web Worker 数量，优化并行计算。
- `deviceMemory` 可用于决定是否加载高内存消耗的素材。

```javascript
const workerCount = navigator.hardwareConcurrency || 4;
const memoryGB = navigator.deviceMemory || 2; // 降级处理
```

---

## 3. 常用方法

`navigator` 还提供了一些方法，允许与设备功能交互。

| 方法                                             | 描述                                                                                  | 备注                         |
| ------------------------------------------------ | ------------------------------------------------------------------------------------- | ---------------------------- |
| `javaEnabled()`                                  | 返回布尔值，表示浏览器是否启用了 Java（已过时，始终返回 `false`）。                   | 不要使用                     |
| `sendBeacon(url, data)`                          | 异步向服务器发送少量数据，通常用于页面卸载时上报统计信息。                            | 可靠，不阻塞页面卸载         |
| `vibrate(pattern)`                               | 触发设备振动（如果支持）。`pattern` 可以是数字（振动毫秒数）或数组（振动/停顿交替）。 | 移动端常用                   |
| `share(data)`                                    | 调用系统的分享面板（Web Share API）。                                                 | 需用户手势触发，仅支持 HTTPS |
| `canShare(data)`                                 | 检查数据是否可分享（Web Share API Level 2）。                                         |                              |
| `getBattery()`                                   | 返回一个 Promise，解析为 `BatteryManager` 对象，提供电池信息。                        | 部分浏览器支持               |
| `requestMediaKeySystemAccess(keySystem, config)` | 用于检查加密媒体扩展（EME）的支持情况。                                               | DRM 相关                     |
| `registerProtocolHandler(scheme, url, title)`    | 将网站注册为某种协议（如 `mailto`）的处理程序。                                       | 需用户确认                   |

### 3.1 `sendBeacon` 示例

用于页面关闭时发送统计信息：

```javascript
window.addEventListener('unload', () => {
  navigator.sendBeacon('/log', 'page=leave');
});
```

### 3.2 Web Share API 示例

```javascript
button.addEventListener('click', async () => {
  try {
    await navigator.share({
      title: '分享标题',
      text: '分享描述',
      url: 'https://example.com'
    });
    console.log('分享成功');
  } catch (err) {
    console.log('分享失败或取消', err);
  }
});
```

### 3.3 振动示例

```javascript
// 振动 200ms
navigator.vibrate(200);

// 振动模式：振动200ms，暂停100ms，再振动200ms
navigator.vibrate([200, 100, 200]);

// 停止振动
navigator.vibrate(0);
```

---

## 4. 用户代理字符串（User-Agent）

用户代理字符串是 `navigator.userAgent` 返回的字符串，它最初用于让服务器识别客户端的浏览器和操作系统，以返回适配的内容。然而，由于历史原因，它变得极其复杂且容易被伪装。

### 4.1 历史与格式

典型的 User-Agent 字符串格式（以 Chrome 为例）：

```bash
Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36
```

各部分含义：

- **`Mozilla/5.0`**：历史遗留，表示与 Netscape 兼容。
- **`(Windows NT 10.0; Win64; x64)`**：操作系统信息。
- **`AppleWebKit/537.36`**：浏览器引擎。
- **`(KHTML, like Gecko)`**：宣称兼容 KHTML 和 Gecko。
- **`Chrome/120.0.0.0 Safari/537.36`**：实际浏览器和版本，以及冒充的 Safari。

### 4.2 为什么 User-Agent 不可靠？

- **伪装**：许多浏览器为了兼容性，会在 UA 中包含其他浏览器的标识。
- **用户修改**：用户可以通过浏览器设置或扩展修改 UA。
- **隐私模式**：某些隐私模式可能隐藏或简化 UA。
- **新浏览器**：新出现的浏览器可能使用与主流相同的 UA 字符串。

因此，**强烈不建议**依赖 UA 字符串来检测浏览器功能。

### 4.3 替代方案：特征检测

特征检测是指直接测试某个功能是否存在，而不是推断浏览器类型。例如：

```javascript
// 错误：检测浏览器
if (navigator.userAgent.includes('Chrome')) {
  // 使用 WebP
}

// 正确：检测功能
function supportsWebP() {
  const canvas = document.createElement('canvas');
  return canvas.toDataURL('image/webp').indexOf('image/webp') === 5;
}
```

常用的特征检测库如 Modernizr，可以帮助开发者进行可靠的检测。

### 4.4 用户代理客户端提示（User-Agent Client Hints）

为了解决 UA 字符串的问题，现代浏览器引入了 **User-Agent Client Hints** 机制。服务器通过请求头（如 `Accept-CH`）主动询问客户端提供特定信息，客户端可以选择性地返回。同时，`navigator.userAgentData` 提供了访问这些信息的 JavaScript 接口（实验性）。

```javascript
// 获取品牌和版本（如果支持）
if (navigator.userAgentData) {
  navigator.userAgentData.brands.forEach(brand => {
    console.log(brand.brand, brand.version);
  });
  // 获取移动设备信息
  console.log(navigator.userAgentData.mobile);
  // 获取平台信息
  navigator.userAgentData.getHighEntropyValues(['platform', 'architecture'])
    .then(values => console.log(values));
}
```

目前，该 API 在 Chromium 浏览器中已可用，其他浏览器正在跟进。这将是未来替代传统 UA 的更好方案。

---

## 5. 隐私与安全考量

`navigator` 对象暴露了大量信息，这些信息可以被用于浏览器指纹识别，追踪用户。因此，现代浏览器逐渐限制或模糊某些属性：

- **`navigator.platform`** 可能返回空字符串或通用值。
- **`navigator.deviceMemory`** 提供的是近似值（如 0.25、0.5、1、2、4、8），且可能被禁用。
- **`navigator.hardwareConcurrency`** 在某些浏览器中已被限制（如 Tor 浏览器返回 2）。
- **User-Agent 字符串** 正在被冻结或简化（如 Firefox 已简化）。

### 5.1 最佳实践

- **不要依赖 UA 做安全决策**：例如不要用 UA 判断是否是移动端来限制访问，因为 UA 可伪造。
- **仅获取必要信息**：例如只需要知道是否支持触摸，就检测 `'ontouchstart' in window`，而不是读取 `maxTouchPoints`。
- **尊重用户隐私**：不要滥用 `navigator` 信息进行指纹追踪。
- **使用渐进增强**：为所有浏览器提供基础功能，再对支持高级特性的浏览器增强体验。

---

## 6. 综合示例：构建一个环境检测工具

以下示例展示如何使用 `navigator` 对象收集环境信息，并输出给开发者（用于调试）。

```javascript
function getBrowserInfo() {
  const info = {
    userAgent: navigator.userAgent,
    language: navigator.language,
    languages: navigator.languages,
    platform: navigator.platform,
    cookieEnabled: navigator.cookieEnabled,
    onLine: navigator.onLine,
    hardwareConcurrency: navigator.hardwareConcurrency,
    deviceMemory: navigator.deviceMemory,
    maxTouchPoints: navigator.maxTouchPoints,
    vendor: navigator.vendor
  };

  // 检测触摸支持（除了 maxTouchPoints，还有事件检测）
  info.touchSupport = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

  // Web Share API 支持
  info.canShare = typeof navigator.share === 'function';

  // 振动支持
  info.canVibrate = typeof navigator.vibrate === 'function';

  // 媒体查询：深色模式
  info.prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;

  return info;
}

console.table(getBrowserInfo());
```

---

## 7. 最佳实践与注意事项

1. **优先特征检测**：始终检查特定功能是否存在，而不是依赖浏览器名称或版本。
2. **处理降级**：当功能不支持时，提供合理的替代方案。
3. **注意异步方法**：如 `share()`、`getBattery()` 返回 Promise，需正确处理。
4. **响应离线状态**：监听 `online`/`offline` 事件，更新 UI 或缓存策略。
5. **尊重用户手势**：调用 Web Share API 等需要用户交互触发。
6. **避免滥用 sendBeacon**：只应在页面卸载时发送关键数据，且数据量不宜过大。
7. **了解浏览器兼容性**：在 MDN 上查阅各属性的支持情况。

---

## 小结

`navigator` 对象是连接网页与浏览器环境的重要桥梁。它提供了丰富的设备和浏览器信息，但同时也伴随着隐私和可靠性问题。通过本章的学习，你应该能够：

- 掌握 `navigator` 的主要属性和方法。
- 理解用户代理字符串的局限性和替代方案。
- 学会使用特征检测而非 UA 检测。
- 合理利用现代 API（如 Web Share、Beacon、Client Hints）。
- 在开发中注意隐私和最佳实践。

随着 Web 平台的发展，`navigator` 的功能将持续演进，但“检测能力而非浏览器”的原则将始终适用。

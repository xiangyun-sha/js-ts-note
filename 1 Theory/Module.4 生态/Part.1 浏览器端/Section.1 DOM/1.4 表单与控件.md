# s表单与控件

[TOC]

---

表单（Form）是用户与网页交互的重要方式，它允许用户输入数据、提交信息或触发操作。HTML 提供了一系列表单控件（如输入框、复选框、下拉列表等），而 JavaScript 则赋予我们动态获取、验证、处理这些数据的能力。本章将全面介绍表单的构成、各类控件的用法、表单事件以及如何通过 JavaScript 操控表单，帮助你构建功能完善且用户体验良好的表单交互。

---

## 1. 表单概述

### 1.1 什么是表单？

`<form>` 元素用于创建包含交互控件的区域，用户可以在其中输入数据并提交到服务器进行处理。即使不需要向服务器发送数据（如单页应用中的表单），`<form>` 元素仍然提供了一种组织控件和处理提交事件的便捷方式。

### 1.2 基本结构

一个最简单的表单包含以下部分：

```html
<form action="/submit" method="post">
  <!-- 表单控件放在这里 -->
  <button type="submit">提交</button>
</form>
```

- **`action`**：指定提交数据的 URL。如果省略，则提交到当前页面的 URL。
- **`method`**：指定 HTTP 方法，通常是 `get` 或 `post`。`get` 将数据附加到 URL 查询字符串，`post` 将数据放在请求体中。

### 1.3 表单与 JavaScript 的关系

JavaScript 可以在表单生命周期的各个阶段介入：

- 获取和设置控件的值。
- 监听控件的变化，实现实时反馈（如表单验证）。
- 拦截提交事件，进行自定义处理（如通过 AJAX 提交）。
- 动态创建或修改表单控件。

---

## 2. 常用表单控件

HTML 提供了丰富的表单控件元素，每个控件都有特定的属性和用途。

### 2.1 `<input>` 元素

`<input>` 是最灵活的表单控件，其类型由 `type` 属性决定。

| 类型                               | 描述                                                 | 示例                                                   |
| ---------------------------------- | ---------------------------------------------------- | ------------------------------------------------------ |
| `text`                             | 单行文本输入框                                       | `<input type="text" name="username">`                  |
| `password`                         | 密码输入框（输入内容被遮挡）                         | `<input type="password" name="pwd">`                   |
| `email`                            | 电子邮件地址输入，移动端会调出相应键盘，支持内置验证 | `<input type="email" name="email">`                    |
| `number`                           | 数字输入框，可设置 min、max、step                    | `<input type="number" name="age" min="0" max="120">`   |
| `tel`                              | 电话号码输入，移动端调出数字键盘                     | `<input type="tel" name="phone">`                      |
| `url`                              | 网址输入                                             | `<input type="url" name="website">`                    |
| `checkbox`                         | 复选框，可同时选中多个                               | `<input type="checkbox" name="hobby" value="reading">` |
| `radio`                            | 单选按钮，同一组内只能选一个                         | `<input type="radio" name="gender" value="male">`      |
| `file`                             | 文件选择                                             | `<input type="file" name="avatar" accept="image/*">`   |
| `hidden`                           | 隐藏字段，用户不可见，用于携带额外数据               | `<input type="hidden" name="userId" value="123">`      |
| `submit`                           | 提交按钮，点击后触发表单提交                         | `<input type="submit" value="提交">`                   |
| `reset`                            | 重置按钮，将表单所有控件恢复为初始值                 | `<input type="reset" value="重置">`                    |
| `button`                           | 普通按钮，无默认行为，常与 JavaScript 配合           | `<input type="button" value="点击">`                   |
| `color`                            | 颜色选择器                                           | `<input type="color" name="bgcolor">`                  |
| `date` / `time` / `datetime-local` | 日期/时间选择器                                      | `<input type="date" name="birthday">`                  |
| `range`                            | 滑块                                                 | `<input type="range" name="volume" min="0" max="100">` |
| `search`                           | 搜索框，样式略有不同                                 | `<input type="search" name="q">`                       |

### 2.2 `<textarea>` 多行文本域

用于输入多行文本，可通过 `rows` 和 `cols` 设置大小，但通常用 CSS 控制。

```html
<textarea name="bio" rows="4" cols="50">默认文本</textarea>
```

### 2.3 `<select>` 下拉列表

- **`<select>`** 创建下拉框，可设置 `multiple` 实现多选。
- **`<option>`** 定义选项，`selected` 属性设置默认选中项。
- **`<optgroup>`** 对选项进行分组。

```html
<select name="city">
  <option value="">请选择城市</option>
  <optgroup label="国内">
    <option value="beijing">北京</option>
    <option value="shanghai" selected>上海</option>
  </optgroup>
  <optgroup label="国外">
    <option value="ny">纽约</option>
  </optgroup>
</select>

<!-- 多选下拉框 -->
<select name="hobbies" multiple size="4">
  <option value="reading">阅读</option>
  <option value="sports">运动</option>
</select>
```

### 2.4 `<button>` 元素

`<button>` 比 `<input type="button">` 更灵活，可以包含 HTML 内容（如图标）。其 `type` 属性默认为 `submit`，所以如果放在表单内且未指定类型，点击会触发表单提交。

```html
<button type="button">普通按钮</button>
<button type="submit">提交按钮</button>
<button type="reset">重置按钮</button>
```

### 2.5 `<label>` 标签

`<label>` 用于将文本与控件关联起来，提升可访问性和用户体验。点击标签文本会聚焦到关联的控件。

两种关联方式：

1. 使用 `for` 属性指向控件的 `id`：

   ```html
   <label for="username">用户名:</label>
   <input type="text" id="username" name="username">
   ```

2. 将控件放在 `<label>` 内部：

   ```html
   <label>
     用户名:
     <input type="text" name="username">
   </label>
   ```

### 2.6 `<fieldset>` 与 `<legend>`

`<fieldset>` 将一组相关控件分组，`<legend>` 提供分组的标题。常用于单选按钮组或复杂表单的区块。

```html
<fieldset>
  <legend>性别</legend>
  <label><input type="radio" name="gender" value="male"> 男</label>
  <label><input type="radio" name="gender" value="female"> 女</label>
</fieldset>
```

---

## 3. 表单与控件的重要属性

### 3.1 基本属性

| 属性           | 适用控件               | 描述                                                                                      |
| -------------- | ---------------------- | ----------------------------------------------------------------------------------------- |
| `name`         | 所有控件               | 控件的名称，在提交数据时作为键。                                                          |
| `value`        | 大部分控件             | 控件的值。对于文本输入是输入的文本，对于复选框/单选是提交时的值，对于按钮是按钮上的文字。 |
| `disabled`     | 所有控件               | 布尔属性，禁用控件，用户无法与之交互，且值不会被提交。                                    |
| `readonly`     | 文本类输入、`textarea` | 只读，用户不能修改，但值会被提交。                                                        |
| `required`     | 大部分控件             | 布尔属性，表示提交前必须填写/选中。                                                       |
| `placeholder`  | 文本类输入、`textarea` | 提示用户输入的示例文本，实际输入后消失。                                                  |
| `autofocus`    | 所有控件               | 页面加载时自动聚焦到该控件。                                                              |
| `autocomplete` | 文本类输入             | 是否启用浏览器自动填充，可设为 `on`/`off`。                                               |

### 3.2 验证相关属性

| 属性          | 适用控件                     | 描述                      |
| ------------- | ---------------------------- | ------------------------- |
| `pattern`     | 文本类输入                   | 用正则表达式验证输入。    |
| `min` / `max` | `number`、`range`、`date` 等 | 数值或日期的最小/最大值。 |
| `step`        | `number`、`range`            | 步进间隔。                |
| `maxlength`   | 文本类输入、`textarea`       | 最大字符数。              |
| `minlength`   | 文本类输入、`textarea`       | 最小字符数。              |

### 3.3 特殊属性

- **`multiple`**：可用于 `<input type="file">` 和 `<select>`，允许选择多个文件/选项。
- **`accept`**：用于 `<input type="file">`，限制可选的文件类型（如 `image/*`）。

---

## 4. 表单与控件的常用事件

### 4.1 表单事件

| 事件     | 描述                                                           |
| -------- | -------------------------------------------------------------- |
| `submit` | 表单提交前触发。可在监听器中调用 `preventDefault()` 阻止提交。 |
| `reset`  | 表单重置前触发。可阻止默认重置行为。                           |

```javascript
const form = document.getElementById('myForm');
form.addEventListener('submit', (e) => {
  e.preventDefault(); // 阻止默认提交
  // 自定义提交逻辑（如 AJAX）
});
```

### 4.2 控件事件

| 事件     | 描述                                                                                     |
| -------- | ---------------------------------------------------------------------------------------- |
| `input`  | 输入值改变时立即触发（每输入一个字符都会触发）。                                         |
| `change` | 值改变且失去焦点时触发（对于文本输入）；对于复选框、单选、选择框，在选择改变时立即触发。 |
| `focus`  | 获得焦点时触发。                                                                         |
| `blur`   | 失去焦点时触发。                                                                         |

```javascript
const emailInput = document.getElementById('email');
emailInput.addEventListener('input', (e) => {
  console.log('当前值:', e.target.value);
});
emailInput.addEventListener('blur', (e) => {
  // 执行验证
});
```

### 4.3 其他事件

- `select`：当 `<textarea>` 或文本输入中的文本被选中时触发。
- `invalid`：当控件验证失败时触发（可用于自定义验证样式）。

---

## 5. 使用 JavaScript 操作表单与控件

### 5.1 获取表单和控件

#### 通过 `id` 或选择器

```javascript
const form = document.getElementById('loginForm');
const username = document.querySelector('#username');
```

#### 通过 `forms` 集合和 `elements` 集合

每个表单都有一个 `elements` 属性，可以通过 `name` 或索引访问控件。

```html
<form name="login">
  <input name="username">
  <input name="password">
</form>
```

```javascript
const form = document.forms.login; // 或 document.forms[0]
const username = form.elements.username; // 或 form['username']
const password = form.elements.password;
```

### 5.2 获取和设置控件值

#### 文本输入、文本域、隐藏字段

使用 `value` 属性。

```javascript
const input = document.getElementById('name');
input.value = '张三'; // 设置值
console.log(input.value); // 获取值
```

#### 复选框和单选按钮

- **`checked`** 属性：布尔值，表示是否选中。
- **`value`** 属性：获取或设置提交时的值。

```javascript
const checkbox = document.getElementById('agree');
console.log(checkbox.checked); // true/false
checkbox.checked = true;

// 遍历一组单选按钮
const radios = document.getElementsByName('gender');
let selectedValue;
for (const radio of radios) {
  if (radio.checked) {
    selectedValue = radio.value;
    break;
  }
}
```

#### 下拉列表（`<select>`）

- **`value`**：获取或设置选中的 `<option>` 的 `value`（如果未设置 `value`，则为选项的文本）。
- **`selectedIndex`**：选中项的索引（对于单选框）。
- **`options`**：包含所有 `<option>` 的集合。
- 对于多选列表，需要遍历 `options` 检查每个 `option.selected`。

```javascript
const select = document.getElementById('city');
console.log(select.value); // 当前选中的值
select.value = 'shanghai'; // 设置选中项（通过 value）

// 多选
const hobbies = document.getElementById('hobbies');
const selectedValues = [];
for (const option of hobbies.options) {
  if (option.selected) {
    selectedValues.push(option.value);
  }
}
```

### 5.3 表单验证

#### 浏览器内置验证 API

每个表单控件都有以下方法：

- **`checkValidity()`**：检查控件是否满足验证约束（如 `required`、`pattern`），返回布尔值，并触发 `invalid` 事件。
- **`reportValidity()`**：类似 `checkValidity()`，但还会在浏览器中显示验证错误提示。
- **`setCustomValidity(message)`**：设置自定义验证错误信息。如果 `message` 非空字符串，则控件被视为无效，并显示该错误信息。设置空字符串可清除自定义错误。

```javascript
const email = document.getElementById('email');
if (!email.checkValidity()) {
  email.setCustomValidity('请输入有效的电子邮件地址');
} else {
  email.setCustomValidity(''); // 清除自定义错误
}
```

#### 使用 `novalidate` 属性

在 `<form>` 上添加 `novalidate` 属性可以禁用浏览器的内置验证，完全由 JavaScript 控制。

```html
<form novalidate>
  <!-- 控件 -->
</form>
```

#### 利用 CSS 伪类

浏览器自动为通过验证和未通过验证的控件添加 CSS 伪类，可用于样式反馈：

- `:valid`：验证通过的控件。
- `:invalid`：验证未通过的控件。
- `:required`：有 `required` 属性的控件。
- `:optional`：无 `required` 属性的控件。

```css
input:invalid {
  border: 2px solid red;
}
input:valid {
  border: 2px solid green;
}
```

### 5.4 提交和重置表单

- **`form.submit()`**：以编程方式提交表单（不会触发 `submit` 事件，所以如果需要在提交前处理，需手动调用逻辑）。
- **`form.reset()`**：重置表单到初始状态（会触发 `reset` 事件）。

```javascript
const form = document.getElementById('myForm');
// 自定义提交
document.getElementById('saveBtn').addEventListener('click', () => {
  if (form.checkValidity()) {
    form.submit(); // 直接提交
  }
});
```

### 5.5 FormData 对象

`FormData` 对象用于收集表单中的数据，特别适合通过 AJAX 发送表单数据（包括文件）。

```javascript
const form = document.getElementById('myForm');
form.addEventListener('submit', (e) => {
  e.preventDefault();
  const formData = new FormData(form);
  
  // 使用 fetch 发送
  fetch('/submit', {
    method: 'POST',
    body: formData
  });
});
```

也可以手动添加或修改数据：

```javascript
const formData = new FormData();
formData.append('username', '张三');
formData.append('avatar', fileInput.files[0]);
```

常用方法：

- `append(name, value)`：添加字段，允许同名键。
- `set(name, value)`：设置字段，会覆盖同名键。
- `delete(name)`：删除字段。
- `get(name)`：获取字段的第一个值。
- `getAll(name)`：获取字段的所有值（数组）。
- `has(name)`：检查是否存在字段。
- `keys()`、`values()`、`entries()` 返回迭代器。

---

## 6. 表单验证示例

以下是一个完整的注册表单，包含前端验证和自定义错误消息。

```html
<form id="registerForm" novalidate>
  <div>
    <label for="username">用户名:</label>
    <input type="text" id="username" name="username" required minlength="3">
    <span class="error" id="usernameError"></span>
  </div>
  <div>
    <label for="email">邮箱:</label>
    <input type="email" id="email" name="email" required>
    <span class="error" id="emailError"></span>
  </div>
  <div>
    <label for="password">密码:</label>
    <input type="password" id="password" name="password" required minlength="6">
    <span class="error" id="passwordError"></span>
  </div>
  <div>
    <label><input type="checkbox" name="agree" required> 同意条款</label>
    <span class="error" id="agreeError"></span>
  </div>
  <button type="submit">注册</button>
</form>
```

```javascript
const form = document.getElementById('registerForm');
const fields = ['username', 'email', 'password', 'agree'];

function showError(fieldName, message) {
  document.getElementById(`${fieldName}Error`).textContent = message;
}

function clearErrors() {
  fields.forEach(field => showError(field, ''));
}

form.addEventListener('submit', (e) => {
  e.preventDefault();
  clearErrors();

  let isValid = true;

  const username = document.getElementById('username');
  if (!username.value) {
    showError('username', '用户名不能为空');
    isValid = false;
  } else if (username.value.length < 3) {
    showError('username', '用户名至少3个字符');
    isValid = false;
  }

  const email = document.getElementById('email');
  if (!email.value) {
    showError('email', '邮箱不能为空');
    isValid = false;
  } else if (!email.checkValidity()) {
    showError('email', '请输入有效的邮箱地址');
    isValid = false;
  }

  const password = document.getElementById('password');
  if (!password.value) {
    showError('password', '密码不能为空');
    isValid = false;
  } else if (password.value.length < 6) {
    showError('password', '密码至少6位');
    isValid = false;
  }

  const agree = document.getElementById('agree');
  if (!agree.checked) {
    showError('agree', '请同意条款');
    isValid = false;
  }

  if (isValid) {
    // 使用 FormData 收集数据并提交
    const formData = new FormData(form);
    fetch('/register', {
      method: 'POST',
      body: formData
    }).then(response => {
      if (response.ok) {
        alert('注册成功');
      }
    }).catch(err => {
      console.error('提交失败', err);
    });
  }
});
```

---

## 7. 最佳实践与注意事项

1. **始终提供 `name` 属性**  
   没有 `name` 的控件值不会被提交到服务器（除非通过 JavaScript 手动收集）。

2. **使用 `<label>` 关联控件**  
   提升可访问性和用户体验，扩大点击区域。

3. **为表单添加 `novalidate` 以完全控制验证**  
   这样可以避免浏览器的内置验证提示与自定义验证冲突。

4. **使用 `FormData` 简化数据收集**  
   尤其适合包含文件的表单，避免手动拼接数据。

5. **验证不仅在前端，后端也要做**  
   前端验证提升用户体验，后端验证保证安全。

6. **谨慎使用 `disabled` vs `readonly`**  
   `disabled` 控件值不会提交，`readonly` 会提交。

7. **在 `submit` 事件中调用 `preventDefault()`**  
   而不是在按钮的 `click` 事件中，因为表单也可能通过其他方式提交（如回车）。

8. **考虑移动端输入类型**  
   使用 `type="tel"`、`type="email"` 等可以调出更适合的键盘。

9. **实时验证与防抖**  
   在 `input` 事件中做实时验证时，可考虑防抖（debounce），避免频繁验证消耗性能。

10. **处理文件上传**  
    通过 `FormData` 发送文件，并确保服务器端能接收 `multipart/form-data`。

---

## 小结

表单是 Web 应用收集用户输入的核心手段。本章系统介绍了：

- 表单的基本结构和属性。
- 各种表单控件的用法和类型。
- 表单与控件的重要属性（包括验证属性）。
- 常用表单事件及其应用。
- 如何通过 JavaScript 获取、设置、验证和提交表单数据。
- FormData 对象的使用。
- 一个完整的表单验证示例。
- 开发中的最佳实践。

掌握这些知识，你就能构建出交互友好、验证完善、用户体验良好的表单，无论是传统提交还是现代单页应用中的动态表单，都能游刃有余。

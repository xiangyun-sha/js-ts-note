# DOM 树与节点类型

[TOC]

---

文档对象模型（Document Object Model，简称 DOM）是浏览器将 HTML 或 XML 文档解析后形成的树状结构。DOM 将文档的每个部分（如元素、属性、文本）都映射为一个**节点**（Node），这些节点通过父子、兄弟关系组成一棵树，开发者可以通过 JavaScript 操作这棵树来动态修改页面内容和结构。

理解 DOM 树及其节点类型，是掌握前端开发的基础。本章将系统介绍 DOM 树的构成、各种节点类型的特点、节点之间的关系以及常用的节点操作方法。

---

## 1. 概述

### 1.1 什么是 DOM 树？

当浏览器加载一个 HTML 页面时，它会解析 HTML 标签，并将其构建为一个树形结构，称为 DOM 树。树的根节点是 `document`，每个 HTML 标签对应一个**元素节点**（Element Node），标签内的文本对应**文本节点**（Text Node），属性对应**属性节点**（Attribute Node），注释对应**注释节点**（Comment Node）。整个树形结构反映了文档的层级关系。

```html
<!DOCTYPE html>
<html>
  <head>
    <title>示例页面</title>
  </head>
  <body>
    <h1 id="title">Hello, DOM!</h1>
    <p>这是一个段落。</p>
  </body>
</html>
```

上述 HTML 对应的 DOM 树结构（简化）如下：

```bash
document
  └─ html
       ├─ head
       │    └─ title
       │         └─ "示例页面" (文本节点)
       └─ body
            ├─ h1 (id="title")
            │    └─ "Hello, DOM!" (文本节点)
            └─ p
                 └─ "这是一个段落。" (文本节点)
```

### 1.2 节点（Node）的概念

DOM 中的每一个组成部分都是一个**节点**。所有节点都继承自一个基类——`Node`，因此它们共享一些基础的属性和方法。根据节点的类型不同，它们还可能拥有各自特有的属性和方法。

---

## 2. Node 类型基础

`Node` 是一个接口，所有 DOM 节点类型都实现了该接口。它定义了一组所有节点共有的属性和方法。

### 2.1 常用属性

| 属性                              | 描述                                                                          | 示例                                 |
| --------------------------------- | ----------------------------------------------------------------------------- | ------------------------------------ |
| `nodeType`                        | 返回节点的类型常量（数字）。                                                  | `element.nodeType === 1`（元素节点） |
| `nodeName`                        | 返回节点的名称。对于元素节点，是大写的标签名；对于文本节点，是 `"#text"`。    | `document.body.nodeName` → `"BODY"`  |
| `nodeValue`                       | 返回或设置节点的值。对于元素节点，通常为 `null`；对于文本节点，返回文本内容。 | `textNode.nodeValue = "新内容"`      |
| `parentNode`                      | 返回父节点（可能是元素节点或 `document`）。                                   |                                      |
| `childNodes`                      | 返回一个包含所有子节点的类数组对象（`NodeList`）。                            |                                      |
| `firstChild` / `lastChild`        | 返回第一个/最后一个子节点，没有则返回 `null`。                                |                                      |
| `previousSibling` / `nextSibling` | 返回前一个/后一个兄弟节点。                                                   |                                      |
| `ownerDocument`                   | 返回节点所属的 `document` 对象。                                              |                                      |

### 2.2 常用方法

| 方法                                   | 描述                                                  |
| -------------------------------------- | ----------------------------------------------------- |
| `appendChild(node)`                    | 将节点添加为最后一个子节点。                          |
| `insertBefore(newNode, referenceNode)` | 在参考节点前插入新节点。                              |
| `removeChild(node)`                    | 移除指定子节点。                                      |
| `replaceChild(newNode, oldNode)`       | 替换子节点。                                          |
| `cloneNode(deep)`                      | 克隆节点，`deep` 为 `true` 表示深克隆（包括子节点）。 |
| `hasChildNodes()`                      | 返回布尔值，表示是否有子节点。                        |

---

## 3. 节点类型常量

`Node` 定义了一组常量，用于与 `nodeType` 属性比较。常用的节点类型常量如下：

| 常量                               | 值  | 描述                                                              |
| ---------------------------------- | --- | ----------------------------------------------------------------- |
| `Node.ELEMENT_NODE`                | 1   | 元素节点，如 `<div>`、`<p>`。                                     |
| `Node.ATTRIBUTE_NODE`              | 2   | 属性节点，如 `id="title"`（已不常用，属性通常通过元素方法操作）。 |
| `Node.TEXT_NODE`                   | 3   | 文本节点，包含元素内的文本内容。                                  |
| `Node.CDATA_SECTION_NODE`          | 4   | CDATA 节（在 XML 中使用）。                                       |
| `Node.PROCESSING_INSTRUCTION_NODE` | 7   | 处理指令节点。                                                    |
| `Node.COMMENT_NODE`                | 8   | 注释节点，如 `<!-- 注释 -->`。                                    |
| `Node.DOCUMENT_NODE`               | 9   | 文档节点，即 `document`。                                         |
| `Node.DOCUMENT_TYPE_NODE`          | 10  | 文档类型节点，如 `<!DOCTYPE html>`。                              |
| `Node.DOCUMENT_FRAGMENT_NODE`      | 11  | 文档片段节点，用于批量操作节点。                                  |

**示例**：判断节点类型

```javascript
const node = document.getElementById('title');
if (node.nodeType === Node.ELEMENT_NODE) {
  console.log('这是一个元素节点');
}
```

---

## 4. 文档节点（Document）

`document` 对象是 DOM 树的根节点，它代表整个 HTML 文档。`document` 本身是 `Document` 类型的实例，其 `nodeType` 为 9，`nodeName` 为 `"#document"`。

### 4.1 常用属性

| 属性              | 描述                                                 |
| ----------------- | ---------------------------------------------------- |
| `documentElement` | 返回文档的根元素，对于 HTML 文档，即 `<html>` 元素。 |
| `body`            | 返回 `<body>` 元素。                                 |
| `head`            | 返回 `<head>` 元素。                                 |
| `title`           | 获取或设置文档标题。                                 |
| `forms`           | 返回所有 `<form>` 元素的集合。                       |
| `images`          | 返回所有 `<img>` 元素的集合。                        |
| `links`           | 返回所有带 `href` 的 `<a>` 元素的集合。              |
| `cookie`          | 读取或设置 cookie。                                  |
| `URL`             | 返回当前文档的 URL。                                 |
| `domain`          | 返回当前文档的域名。                                 |

### 4.2 常用方法

| 方法                                | 描述                                       |
| ----------------------------------- | ------------------------------------------ |
| `getElementById(id)`                | 通过 `id` 获取元素节点。                   |
| `getElementsByTagName(tagName)`     | 通过标签名获取元素节点集合（动态更新）。   |
| `getElementsByClassName(className)` | 通过类名获取元素节点集合。                 |
| `querySelector(selector)`           | 返回匹配 CSS 选择器的第一个元素。          |
| `querySelectorAll(selector)`        | 返回匹配 CSS 选择器的所有元素的静态列表。  |
| `createElement(tagName)`            | 创建新的元素节点。                         |
| `createTextNode(data)`              | 创建新的文本节点。                         |
| `createComment(data)`               | 创建新的注释节点。                         |
| `createDocumentFragment()`          | 创建文档片段节点。                         |
| `write()`                           | 向文档写入内容（不推荐在页面加载后使用）。 |

**示例**：

```javascript
const mainDiv = document.getElementById('main');
const paragraphs = document.getElementsByTagName('p');
const firstButton = document.querySelector('.btn');
```

---

## 5. 元素节点（Element）

元素节点代表 HTML 标签，是最常见的节点类型。其 `nodeType` 为 1，`nodeName` 为标签名的大写形式（如 `"DIV"`）。

### 5.1 常用属性

| 属性                                            | 描述                                                           |
| ----------------------------------------------- | -------------------------------------------------------------- |
| `tagName`                                       | 返回标签名的大写形式，同 `nodeName`。                          |
| `id`                                            | 获取或设置元素的 `id` 属性。                                   |
| `className`                                     | 获取或设置元素的 `class` 属性（字符串形式）。                  |
| `classList`                                     | 返回元素的类名的 DOMTokenList 对象，便于添加/删除类。          |
| `attributes`                                    | 返回元素的属性集合（NamedNodeMap）。                           |
| `innerHTML`                                     | 获取或设置元素内部的 HTML 内容（包括子元素）。                 |
| `outerHTML`                                     | 获取或设置包含当前元素自身的 HTML 内容。                       |
| `innerText` / `textContent`                     | 获取或设置元素内部的纯文本内容。                               |
| `style`                                         | 返回元素的 CSSStyleDeclaration 对象，用于操作内联样式。        |
| `children`                                      | 返回元素的**元素**子节点集合（不包括文本、注释等）。           |
| `firstElementChild` / `lastElementChild`        | 返回第一个/最后一个**元素**子节点。                            |
| `previousElementSibling` / `nextElementSibling` | 返回前一个/后一个**元素**兄弟节点。                            |
| `clientWidth` / `clientHeight`                  | 获取元素内部内容的可视尺寸（包括内边距，不包括边框和滚动条）。 |
| `offsetWidth` / `offsetHeight`                  | 获取元素布局尺寸（包括边框和内边距）。                         |
| `scrollTop` / `scrollLeft`                      | 获取或设置元素滚动条的位置。                                   |

### 5.2 常用方法

| 方法                                 | 描述                                       |
| ------------------------------------ | ------------------------------------------ |
| `setAttribute(name, value)`          | 设置属性值。                               |
| `getAttribute(name)`                 | 获取属性值。                               |
| `removeAttribute(name)`              | 移除属性。                                 |
| `hasAttribute(name)`                 | 判断是否有指定属性。                       |
| `getBoundingClientRect()`            | 返回元素相对于视口的位置和尺寸信息。       |
| `matches(selector)`                  | 判断元素是否匹配指定 CSS 选择器。          |
| `closest(selector)`                  | 返回匹配选择器的最近祖先元素（包括自身）。 |
| `insertAdjacentHTML(position, text)` | 在指定位置插入 HTML 字符串。               |

**示例**：

```javascript
const div = document.createElement('div');
div.id = 'container';
div.className = 'box';
div.setAttribute('data-custom', 'value');
div.textContent = 'Hello';
document.body.appendChild(div);

// 操作 classList
div.classList.add('active');
div.classList.remove('box');
div.classList.toggle('visible');
```

---

## 6. 文本节点（Text）

文本节点包含元素内的纯文本内容。其 `nodeType` 为 3，`nodeName` 为 `"#text"`。文本节点没有子节点，且通常作为元素节点的子节点存在。

### 6.1 常用属性与方法

| 属性/方法                          | 描述                                                   |
| ---------------------------------- | ------------------------------------------------------ |
| `data`                             | 获取或设置文本节点的内容，同 `nodeValue`。             |
| `length`                           | 返回文本长度。                                         |
| `splitText(offset)`                | 在指定偏移量处将文本节点拆分为两个节点，返回后半部分。 |
| `appendData(text)`                 | 在文本节点末尾追加文本。                               |
| `deleteData(offset, count)`        | 删除从偏移量开始的指定数量字符。                       |
| `insertData(offset, text)`         | 在指定偏移量处插入文本。                               |
| `replaceData(offset, count, text)` | 替换指定范围的文本。                                   |
| `substringData(offset, count)`     | 提取子字符串。                                         |

### 6.2 获取文本节点

元素节点内的文本内容会形成一个或多个文本节点。例如：

```html
<p>Hello <strong>world</strong>!</p>
```

`<p>` 元素的子节点包括：一个文本节点（`"Hello "`）、一个元素节点（`<strong>`）、又一个文本节点（`"!"`）。

通过 `childNodes` 可以访问这些文本节点。

```javascript
const p = document.querySelector('p');
const textNode = p.firstChild; // 获取 "Hello " 文本节点
console.log(textNode.data); // "Hello "
```

### 6.3 注意事项

- 换行和缩进也会被当作文本节点（通常是只包含空格的文本节点）。因此，在遍历 `childNodes` 时需要注意过滤。
- 使用 `textContent` 或 `innerText` 可以一次性获取元素内所有文本，而不必处理单独的文本节点。

---

## 7. 注释节点（Comment）

注释节点对应 HTML 中的注释 `<!-- ... -->`。其 `nodeType` 为 8，`nodeName` 为 `"#comment"`，`nodeValue` 为注释内容（不包括 `<!--` 和 `-->`）。

```html
<!-- 这是一个注释 -->
```

```javascript
const comment = document.createComment('这是一个注释');
document.body.appendChild(comment);
```

注释节点通常不需要频繁操作，但在某些场景（如模板占位）可能会用到。

---

## 8. 其他节点类型

### 8.1 文档类型节点（DocumentType）

对应 `<!DOCTYPE>` 声明。可通过 `document.doctype` 访问。

```javascript
const doctype = document.doctype;
console.log(doctype.name); // "html"
```

### 8.2 文档片段节点（DocumentFragment）

`DocumentFragment` 是一个轻量级的文档对象，它不属于 DOM 树，但可以像容器一样保存节点。当你将文档片段插入到 DOM 树时，其子节点会被插入，而片段本身不会出现。常用于批量添加节点以提高性能。

```javascript
const fragment = document.createDocumentFragment();
for (let i = 0; i < 100; i++) {
  const li = document.createElement('li');
  li.textContent = `Item ${i}`;
  fragment.appendChild(li);
}
document.getElementById('list').appendChild(fragment); // 一次插入，减少重排
```

### 8.3 属性节点（Attribute）

属性节点已不常用，因为现代 DOM 操作通常使用 `getAttribute` / `setAttribute` 直接操作属性。属性节点的 `nodeType` 为 2，但它们不再是 DOM 树的一部分，而是关联到元素节点。通常我们忽略它。

---

## 9. 节点关系与遍历

### 9.1 节点树关系

每个节点都可以通过以下属性访问其相邻节点：

- `parentNode`：父节点。
- `childNodes`：所有子节点（包括文本、注释等）。
- `firstChild` / `lastChild`：第一个/最后一个子节点。
- `previousSibling` / `nextSibling`：前一个/后一个兄弟节点。

对于仅考虑元素节点的关系，可以使用：

- `parentElement`：父元素节点（如果父节点不是元素，则为 `null`）。
- `children`：所有**元素**子节点。
- `firstElementChild` / `lastElementChild`：第一个/最后一个元素子节点。
- `previousElementSibling` / `nextElementSibling`：前一个/后一个元素兄弟节点。

### 9.2 遍历示例

```javascript
const ul = document.querySelector('ul');
// 遍历所有子节点（包括文本）
for (let node = ul.firstChild; node; node = node.nextSibling) {
  console.log(node.nodeName);
}

// 遍历所有元素子节点
for (let elem of ul.children) {
  console.log(elem.tagName);
}
```

### 9.3 NodeList 与 HTMLCollection

- `childNodes` 返回一个 `NodeList`，可能是动态的或静态的（取决于获取方式）。
- `children` 返回一个 `HTMLCollection`，动态集合。
- `querySelectorAll` 返回一个静态的 `NodeList`。

动态集合意味着如果 DOM 树发生变化，集合会自动更新；静态集合则不会。

---

## 10. 节点操作示例

### 10.1 创建并插入节点

```javascript
// 创建元素节点
const div = document.createElement('div');
// 创建文本节点
const text = document.createTextNode('Hello, DOM!');
// 将文本节点添加到 div
div.appendChild(text);
// 将 div 添加到 body
document.body.appendChild(div);
```

### 10.2 插入到指定位置

```javascript
const target = document.getElementById('target');
const newElement = document.createElement('span');
newElement.textContent = '插入的内容';
target.parentNode.insertBefore(newElement, target.nextSibling); // 在 target 后插入
```

更现代的方式：`target.insertAdjacentElement('afterend', newElement)`。

### 10.3 删除节点

```javascript
const node = document.getElementById('toRemove');
node.parentNode.removeChild(node); // 需要父节点调用

// 现代方式：node.remove(); （部分老浏览器不支持）
node.remove();
```

### 10.4 替换节点

```javascript
const oldNode = document.getElementById('old');
const newNode = document.createElement('div');
newNode.textContent = '新节点';
oldNode.parentNode.replaceChild(newNode, oldNode);
```

### 10.5 克隆节点

```javascript
const original = document.getElementById('original');
const shallowCopy = original.cloneNode(false); // 只克隆自身
const deepCopy = original.cloneNode(true);      // 克隆自身及所有子节点
document.body.appendChild(deepCopy);
```

---

## 11. 示例：动态构建一个简单的 DOM 树

```html
<!DOCTYPE html>
<html>
<head>
  <title>DOM 示例</title>
</head>
<body>
  <div id="app"></div>
  <script>
    // 创建文档片段
    const fragment = document.createDocumentFragment();

    // 创建 h1 元素
    const h1 = document.createElement('h1');
    h1.textContent = '用户列表';

    // 创建 ul 元素
    const ul = document.createElement('ul');
    const users = ['Alice', 'Bob', 'Charlie'];
    users.forEach(name => {
      const li = document.createElement('li');
      li.textContent = name;
      ul.appendChild(li);
    });

    // 添加一个注释
    const comment = document.createComment('这里是动态生成的列表');

    // 将节点加入片段
    fragment.appendChild(comment);
    fragment.appendChild(h1);
    fragment.appendChild(ul);

    // 一次性插入到 DOM 树
    document.getElementById('app').appendChild(fragment);
  </script>
</body>
</html>
```

---

## 12. 最佳实践与注意事项

1. **优先使用 `children` 而非 `childNodes`**  
   如果只关心元素节点，使用 `children` 避免处理空白文本节点。

2. **使用 `innerHTML` 时注意安全**  
   `innerHTML` 会解析 HTML 字符串，可能导致 XSS 攻击。如果内容来自用户输入，应先转义。

3. **批量操作节点使用 `DocumentFragment`**  
   多次插入节点会引发多次重排，影响性能。使用 `DocumentFragment` 可以合并为一次操作。

4. **缓存 DOM 查询结果**  
   反复查询同一个 DOM 节点（如 `document.querySelector`）会消耗性能，应将其缓存为变量。

5. **使用现代 API 简化代码**  
   如 `append()`、`prepend()`、`before()`、`after()`、`replaceWith()` 等（注意兼容性）。

6. **理解动态集合的特性**  
   动态集合（如 `getElementsByTagName` 返回的 `HTMLCollection`）会在 DOM 变化时自动更新，可能导致意外循环。如果需要固定集合，使用 `querySelectorAll`。

7. **操作节点前确保存在**  
   在访问节点属性前，检查节点是否为 `null`，避免抛出错误。

8. **避免频繁操作样式**  
   使用 `classList` 切换类，而不是直接修改 `style` 属性（除非需要动态计算）。

---

## 小结

DOM 树是文档的结构化表示，节点是 DOM 的基本单元。本章详细介绍了：

- DOM 树的构成与节点类型（Document、Element、Text、Comment 等）。
- 各节点类型的属性、方法和使用场景。
- 节点之间的关系与遍历方法。
- 创建、插入、删除、克隆节点等操作。
- 性能优化和最佳实践。

掌握 DOM 节点的基础知识，你就能灵活地通过 JavaScript 操控页面内容，为构建动态交互体验打下坚实的基础。下一节我们将深入学习**元素选取与遍历**，更系统地了解如何高效地获取和操作 DOM 节点。
